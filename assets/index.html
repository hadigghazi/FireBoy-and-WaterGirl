<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
</head>
<body>
    <script>
        let characterCanvas;
        let x = 50;
        let y = 50;
        let speed = 2;
        let frameCounter = 0;

        function setup() {
            characterCanvas = createCanvas(100, 100);
            characterCanvas.hide(); // Hide the p5 canvas
            drawCharacter();
        }

        function draw() {
            drawCharacter(x, y);
            moveCharacter();
        }

        function drawCharacter(x = 50, y = 50) {
            clear(); // Clear the canvas

            // Draw the body
            fill(0, 191, 255); // fire-like blue color
            ellipse(x, y, 50, 100); // body

            // Draw the head with fire effect
            drawFire(x, y - 60, 50, 70);

            // Draw the eyes
            fill(255);
            ellipse(x - 15, y - 65, 10, 10); // left eye
            ellipse(x + 15, y - 65, 10, 10); // right eye

            // Draw the mouth
            fill(255);
            arc(x, y - 50, 30, 20, 0, PI); // mouth

            // Draw the arms
            stroke(0, 191, 255);
            strokeWeight(4);
            line(x - 30, y, x - 50, y - 20); // left arm
            line(x + 30, y, x + 50, y - 20); // right arm

            // Draw the legs with walking animation
            drawLegs(x, y + 50);
        }

        function drawFire(x, y, w, h) {
            noStroke();
            for (let i = 0; i < 10; i++) {
                fill(0, 191, 255, 255 - i * 20); // gradient effect
                ellipse(x, y - i * 6, w - i * 4, h - i * 6); // fire layers
            }
        }

        function drawLegs(x, y) {
            stroke(0, 191, 255);
            strokeWeight(4);

            let legMovement = sin(frameCounter * 0.1) * 10; // calculate leg movement

            // Draw left leg
            line(x - 15, y, x - 15, y + 30 + legMovement);

            // Draw right leg
            line(x + 15, y, x + 15, y + 30 - legMovement);
        }

        function moveCharacter() {
            let moving = false;

            if (keyIsDown(65)) { // 'A' key
                x -= speed;
                moving = true;
            }
            if (keyIsDown(68)) { // 'D' key
                x += speed;
                moving = true;
            }
            if (keyIsDown(87)) { // 'W' key
                y -= speed;
                moving = true;
            }
            if (keyIsDown(83)) { // 'S' key
                y += speed;
                moving = true;
            }

            if (moving) {
                frameCounter++; // increment frame counter when character is moving
            } else {
                frameCounter = 0; // reset frame counter when character is not moving
            }
        }

        class Player extends Phaser.GameObjects.Sprite {
            constructor(scene, x, y) {
                super(scene, x, y, 'characterTexture');
                this.setOrigin(0.5);
                scene.add.existing(this);
                scene.physics.add.existing(this);
                this.body.collideWorldBounds = true;
            }
        }


class Generator {
    constructor(scene) {
        this.scene = scene;
        this.scene.time.delayedCall(2000, () => this.init(), null, this);
        this.pinos = 0;
    }

    init() {
        this.generateCloud();
        this.generateObstacle();
        this.generateCoin();
    }

    generateCloud() {
        new Cloud(this.scene);
        this.scene.time.delayedCall(
            Phaser.Math.Between(2000, 3000),
            () => this.generateCloud(),
            null,
            this
        );
    }

    generateObstacle() {
        this.scene.obstacles.add(
            new Obstacle(
                this.scene,
                800,
                this.scene.height - Phaser.Math.Between(32, 128)
            )
        );
        this.scene.time.delayedCall(
            Phaser.Math.Between(1500, 2500),
            () => this.generateObstacle(),
            null,
            this
        );
    }

    generateCoin() {
        this.scene.coins.add(
            new Coin(
                this.scene,
                800,
                this.scene.height - Phaser.Math.Between(32, 128)
            )
        );
        this.scene.time.delayedCall(
            Phaser.Math.Between(500, 1500),
            () => this.generateCoin(1),
            null,
            this
        );
    }
}

class Cloud extends Phaser.GameObjects.Rectangle {
    constructor(scene, x, y) {
        const finalY = y || Phaser.Math.Between(0, 100);
        super(scene, x, finalY, 98, 32, 0xffffff);
        scene.add.existing(this);
        const alpha = 1 / Phaser.Math.Between(1, 3);

        this.setScale(alpha);
        this.init();
    }

    init() {
        this.scene.tweens.add({
            targets: this,
            x: { from: 800, to: -100 },
            duration: 2000 / this.scale,
            onComplete: () => {
                this.destroy();
            },
        });
    }
}

class Obstacle extends Phaser.GameObjects.Rectangle {
    constructor(scene, x, y) {
        super(scene, x, y, 32, 32, 0xff0000);
        scene.add.existing(this);
        scene.physics.add.existing(this);
        this.body.setAllowGravity(false);
        const alpha = 1 / Phaser.Math.Between(1, 3);

        this.init();
    }

    init() {
        this.scene.tweens.add({
            targets: this,
            x: { from: 820, to: -100 },
            duration: 2000,
            onComplete: () => {
                this.destroy();
            },
        });
    }
}

class Coin extends Phaser.GameObjects.Sprite {
    constructor(scene, x, y) {
        super(scene, x, y, "coin");
        scene.add.existing(this);
        scene.physics.add.existing(this);
        this.body.setAllowGravity(false);
        const alpha = 1 / Phaser.Math.Between(1, 3);

        this.init();
    }

    init() {
        this.scene.tweens.add({
            targets: this,
            x: { from: 820, to: -100 },
            duration: 2000,
            onComplete: () => {
                this.destroy();
            },
        });

        const coinAnimation = this.scene.anims.create({
            key: "coin",
            frames: this.scene.anims.generateFrameNumbers("coin", {
                start: 0,
                end: 7,
            }),
            frameRate: 8,
        });
        this.play({ key: "coin", repeat: -1 });
    }
}

class Brick extends Phaser.GameObjects.Sprite {
    constructor(scene, x, y, name = "brick0") {
        super(scene, x, y, name);
        this.name = name;

        this.scene.add.existing(this);
        this.scene.physics.add.existing(this);
        this.body.immovable = true; // Make the brick immovable
        this.body.moves = false; // Ensure the brick doesn't move with physics
        this.setOrigin(0); // Set the origin of the sprite to its top-left corner

        // Example: Add tween animation for visual effect
        this.scene.tweens.add({
            targets: this,
            duration: 50,
            x: { from: this.x, to: this.x + Phaser.Math.Between(-7, 7) },
            y: { from: this.y, to: this.y + Phaser.Math.Between(-7, 7) },
            repeat: 5,
        });
    }
}
  

class GameStart extends Phaser.Scene {
            constructor() {
                super({ key: "gamestart" });
            }

            preload() {
                // Ensure bitmap font is preloaded here
                this.load.bitmapFont("arcade", "./arcade.png", "./arcade.xml");
            }

            create() {
                this.width = this.sys.game.config.width;
                this.height = this.sys.game.config.height;
                this.center_width = this.width / 2;
                this.center_height = this.height / 2;

                this.cameras.main.setBackgroundColor(0x87ceeb);

                this.add
                    .bitmapText(
                        this.center_width,
                        this.center_height,
                        "arcade",
                        "START GAME",
                        45
                    )
                    .setOrigin(0.5);
                this.add
                    .bitmapText(
                        this.center_width,
                        250,
                        "arcade",
                        "Press SPACE or Click to restart!",
                        15
                    )
                    .setOrigin(0.5);
                this.input.keyboard.on("keydown-SPACE", this.startGame, this);
                this.input.on("pointerdown", (pointer) => this.startGame(), this);
            }

            startGame() {
                this.scene.start("game");
            }
        }

class Game extends Phaser.Scene {
    constructor() {
        super({ key: "game" });
        this.player = null;
        this.score = 0;
        this.scoreText = null;
        this.bricks = null;
    }

    init(data) {
        this.name = data.name;
        this.number = data.number;
    }

    preload() {
        this.registry.set("score", "0");
        this.load.image('brick', 'brick0.png');
        this.load.image('character', 'firecharacter.png')
        this.load.audio("coin", "coin.mp3");
        this.load.audio("jump", "jump.mp3");
        this.load.audio("dead", "dead.mp3");
        this.load.audio("theme", "theme.mp3");
        this.load.spritesheet("coin", "coin.png", {
            frameWidth: 32,
            frameHeight: 32,
        });
        this.load.bitmapFont("arcade", "arcade.png", "arcade.xml");
        this.score = 0;
    }

    create() {
        this.width = this.sys.game.config.width;
        this.height = this.sys.game.config.height;
        this.center_width = this.width / 2;
        this.center_height = this.height / 2;

        this.cameras.main.setBackgroundColor(0x87ceeb);
        this.obstacles = this.add.group();
        this.coins = this.add.group();
        this.bricks = this.physics.add.group(); // Group for bricks

        // Generate bricks
        for (let i = 0; i < 5; i++) {
            const brick = new Brick(this, Phaser.Math.Between(100, 700), 300, 'brick');
            this.bricks.add(brick);
        }

        this.generator = new Generator(this);
        this.SPACE = this.input.keyboard.addKey(
            Phaser.Input.Keyboard.KeyCodes.SPACE
        );
        this.player = this.physics.add.sprite(100, 300, 'character');
        this.player.setScale(0.5, 0.5);
        this.player.setCollideWorldBounds(true);
        this.scoreText = this.add.bitmapText(
            this.center_width,
            10,
            "arcade",
            this.score,
            20
        );

        this.physics.add.collider(
            this.player,
            this.obstacles,
            this.hitObstacle,
            null,
            this
        );

        this.physics.add.overlap(
            this.player,
            this.coins,
            this.hitCoin,
            null,
            this
        );

        this.physics.add.collider(
            this.player,
            this.bricks,
            this.hitBrick,
            null,
            this
        );

        this.loadAudios();
        this.playMusic();

        this.input.on("pointerdown", (pointer) => this.jump(), this);

        this.updateScoreEvent = this.time.addEvent({
            delay: 100,
            callback: () => this.updateScore(),
            callbackScope: this,
            loop: true,
        });
    }

    hitObstacle(player, obstacle) {
        this.updateScoreEvent.destroy();
        this.finishScene();
    }

    hitCoin(player, coin) {
        this.playAudio("coin");
        this.updateScore(1000);
        coin.destroy();
    }

    hitBrick(player, brick) {
        // Implement brick collision behavior here if needed
        // For example, stop player movement, play a sound, etc.
    }

    loadAudios() {
        this.audios = {
            jump: this.sound.add("jump"),
            coin: this.sound.add("coin"),
            dead: this.sound.add("dead"),
        };
    }

    playAudio(key) {
        this.audios[key].play();
    }

    playMusic(theme = "theme") {
        this.theme = this.sound.add(theme);
        this.theme.stop();
        this.theme.play({
            mute: false,
            volume: 1,
            rate: 1,
            detune: 0,
            seek: 0,
            loop: true,
            delay: 0,
        });
    }

    update() {
        if (Phaser.Input.Keyboard.JustDown(this.SPACE)) {
            this.jump();
        } else if (this.player.body.blocked.down) {
            this.jumpTween?.stop();
            this.player.rotation = 0;
        }
    }

    jump() {
        if (!this.player.body.blocked.down) return;
        this.player.body.setVelocityY(-300);

        this.playAudio("jump");
        this.jumpTween = this.tweens.add({
            targets: this.player,
            duration: 1000,
            angle: { from: 0, to: 360 },
            repeat: -1,
        });
    }

    finishScene() {
        this.theme.stop();
        this.playAudio("dead");
        this.registry.set("score", "" + this.score);
        this.scene.start("gameover");
    }

    updateScore(points = 1) {
        this.score += points;
        this.scoreText.setText(this.score);
    }
}

class GameOver extends Phaser.Scene {
    constructor() {
        super({ key: "gameover" });
    }

    create() {
        this.width = this.sys.game.config.width;
        this.height = this.sys.game.config.height;
        this.center_width = this.width / 2;
        this.center_height = this.height / 2;

        this.cameras.main.setBackgroundColor(0x87ceeb);

        this.add
            .bitmapText(
                this.center_width,
                50,
                "arcade",
                this.registry.get("score"),
                25
            )
            .setOrigin(0.5);
        this.add
            .bitmapText(
                this.center_width,
                this.center_height,
                "arcade",
                "GAME OVER",
                45
            )
            .setOrigin(0.5);
        this.add
            .bitmapText(
                this.center_width,
                250,
                "arcade",
                "Press SPACE or Click to restart!",
                15
            )
            .setOrigin(0.5);
        this.input.keyboard.on("keydown-SPACE", this.startGame, this);
        this.input.on("pointerdown", (pointer) => this.startGame(), this);
    }

    startGame() {
        this.scene.start("game");
    }
}

const config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    scene: [GameStart, Game, GameOver],
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 200 }
        }
    }
};

const game = new Phaser.Game(config);
</script>

</body>
</html>
